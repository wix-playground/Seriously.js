define(function(){"use strict";if("undefined"!=typeof window){var e={transparent:[0,0,0,0],black:[0,0,0,1],red:[1,0,0,1],green:[0,128/255,0,1],blue:[0,0,1,1],white:[1,1,1,1],silver:[192/255,192/255,192/255,1],gray:[128/255,128/255,128/255,1],maroon:[128/255,0,0,1],purple:[128/255,0,128/255,1],fuchsia:[1,0,1,1],lime:[0,1,0,1],olive:[128/255,128/255,0,1],yellow:[1,1,0,1],navy:[0,0,128/255,1],teal:[0,128/255,128/255,1],aqua:[0,1,1,1],orange:[1,165/255,0,1]},t=/^(rgb|hsl)a?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*(\d+(\.\d*)?)\s*)?\)/i,i=/^#(([0-9a-fA-F]{3,8}))/,r=["x","y","z","w"],o=["r","g","b","a"],s={srcRGB:770,dstRGB:771,srcAlpha:1,dstAlpha:771},n=["MAX_COMBINED_TEXTURE_IMAGE_UNITS","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_TEXTURE_IMAGE_UNITS","MAX_VARYING_VECTORS","MAX_VERTEX_ATTRIBS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_VERTEX_UNIFORM_VECTORS"],a=/^[\t ]*#define[\t ]+SHADER_NAME\s+([^$\n\r]+)/i,u=["alias","destroy","effect","id","initialize","inputs","isDestroyed","isReady","matte","off","on","readPixels","render","title","update"],h=["alias","destroy","id","inputs","isDestroyed","isReady","off","on","source","title","update"],f=["aliases","defaults","destroy","effect","draw","go","id","incompatible","isDestroyed","isEffect","isNode","isSource","isTarget","isTransform","initDaemon","addAlias","removeAlias","render","source","stop","addNode","removeNode","target","transform","getNodeId","findInputNode","addSourceNode","removeSourceNode","addEffectNode","removeEffectNode","addTransformNode","removeTransformNode","addTargetNode","removeTargetNode","commonShaders","auto","attachContext"],d=["precision mediump float;","attribute vec4 position;","attribute vec2 texCoord;","uniform vec2 resolution;","uniform mat4 transform;","varying vec2 vTexCoord;","void main(void) {","\tvec4 screenPosition = vec4(position.xy * resolution / 2.0, position.z, position.w);","\tscreenPosition = transform * screenPosition;","\tgl_Position.xy = screenPosition.xy * 2.0 / resolution;","\tgl_Position.z = screenPosition.z * 2.0 / (resolution.x / resolution.y);","\tgl_Position.w = screenPosition.w;","\tvTexCoord = texCoord;","}\n"].join("\n"),l=["precision mediump float;","varying vec2 vTexCoord;","uniform sampler2D source;","void main(void) {","\t\tgl_FragColor = texture2D(source, vTexCoord);","}"].join("\n"),c=void 0;window.Float32Array&&(c=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]));function p(e,t){var i=void 0,r=void 0;e.prototype&&t.prototype&&e.prototype!==t.prototype&&p(e.prototype,t.prototype);for(i in t)t.hasOwnProperty(i)&&((r=Object.getOwnPropertyDescriptor(t,i)).get||r.set?Object.defineProperty(e,i,{configurable:!0,enumerable:!0,get:r.get,set:r.set}):e[i]=t[i]);return e}function m(e){return Array.isArray(e)||e&&e.BYTES_PER_ELEMENT&&"length"in e}var g={frustum:function(e,t,i,r,o,s,n){n||(n=g.create());var a=t-e,u=r-i,h=s-o;return n[0]=2*o/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*o/u,n[6]=0,n[7]=0,n[8]=(t+e)/a,n[9]=(r+i)/u,n[10]=-(s+o)/h,n[11]=-1,n[12]=0,n[13]=0,n[14]=-s*o*2/h,n[15]=0,n},perspective:function(e,t,i,r,o){var s=i*Math.tan(e*Math.PI/360),n=s*t;return g.frustum(-n,n,-s,s,i,r,o)},multiply:function(e,t,i){var r=t[0],o=t[1],s=t[2],n=t[3],a=t[4],u=t[5],h=t[6],f=t[7],d=t[8],l=t[9],c=t[10],p=t[11],m=t[12],g=t[13],v=t[14],y=t[15],E=i[0],b=i[1],w=i[2],T=i[3];return e[0]=E*r+b*a+w*d+T*m,e[1]=E*o+b*u+w*l+T*g,e[2]=E*s+b*h+w*c+T*v,e[3]=E*n+b*f+w*p+T*y,E=i[4],b=i[5],w=i[6],T=i[7],e[4]=E*r+b*a+w*d+T*m,e[5]=E*o+b*u+w*l+T*g,e[6]=E*s+b*h+w*c+T*v,e[7]=E*n+b*f+w*p+T*y,E=i[8],b=i[9],w=i[10],T=i[11],e[8]=E*r+b*a+w*d+T*m,e[9]=E*o+b*u+w*l+T*g,e[10]=E*s+b*h+w*c+T*v,e[11]=E*n+b*f+w*p+T*y,E=i[12],b=i[13],w=i[14],T=i[15],e[12]=E*r+b*a+w*d+T*m,e[13]=E*o+b*u+w*l+T*g,e[14]=E*s+b*h+w*c+T*v,e[15]=E*n+b*f+w*p+T*y,e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}};function v(e,t,i,r,o){function s(e,t,i){return(i%=1)<0&&(i+=1),i<1/6?e+(t-e)*i*6:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}var n=void 0,a=void 0;return a=i<.5?i*(t+1):i+t-i*t,n=2*i-a,o||(o=[]),o[0]=s(n,a,e+1/3),o[1]=s(n,a,e),o[2]=s(n,a,e-1/3),o[3]=r,o}function y(e){var t=void 0,i=void 0,r=void 0,o="#",s=e[3]<1?4:3;for(t=0;t<s;t++)r=(i=Math.min(255,Math.round(255*e[t]||0))).toString(16),i<16&&(r="0"+r),o+=r;return o}var E=window.console;function b(){}function w(e){var t=void 0;if(!E)return b;if("function"==typeof E[e])t=E[e];else{if("function"!=typeof E.log)return b;t=E.log}return t.bind?t.bind(E):function(){t.apply(E,arguments)}}var T={log:w("log"),info:w("info"),warn:w("warn"),error:w("error")},x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},R=(function(){function e(e){this.value=e}function t(t){function i(o,s){try{var n=t[o](s),a=n.value;a instanceof e?Promise.resolve(a.value).then(function(e){i("next",e)},function(e){i("throw",e)}):r(n.done?"return":"normal",n.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}(o=o.next)?i(o.key,o.arg):s=null}var o,s;this._invoke=function(e,t){return new Promise(function(r,n){var a={key:e,arg:t,resolve:r,reject:n,next:null};s?s=s.next=a:(o=s=a,i(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),window.document),D=[],A=function(){var e=0;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){var i=(new Date).getTime(),r=Math.max(0,16-(i-e)),o=window.setTimeout(function(){t(i+r)},r);return e=i+r,o}}(),N=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){window.cancelTimeout(e)},P=void 0;function _(e,t){var i=void 0,r=void 0;if("string"==typeof e)i=R.querySelector(e);else if(!e)return!1;return e.tagName&&(i=e),i?(r=i.tagName.toLowerCase(),t&&t.indexOf(r)<0?e:i):e}function S(e,t){if(t||(t="HTMLElement"),e instanceof window[t])return!0;if(!e||"object"!==(void 0===e?"undefined":x(e)))return!1;for(;e;)if((e=Object.getPrototypeOf(e))&&e.constructor.name===t)return!0;return!1}function F(e){if("function"!=typeof e)throw new Error("setTimeoutZero argument is not a function");D.push(e),"file:"!==window.location.protocol?window.postMessage("seriously-timeout-message",window.location):setTimeout(function(){D.length&&D.shift()()},0)}window.addEventListener("message",function(e){e.source===window&&"seriously-timeout-message"===e.data&&(e.stopPropagation(),D.length>0&&D.shift()())},!0);function O(e,t){var i=void 0;try{i=window.WebGLDebugUtils&&t&&t.debugContext?window.WebGLDebugUtils.makeDebugContext(e.getContext("webgl",t)):e.getContext("webgl",t)}catch(e){}if(!i)try{i=e.getContext("experimental-webgl",t)}catch(e){}return i}function U(e){var t=void 0;return P&&P.getError()===P.CONTEXT_LOST_WEBGL&&(P=void 0),P||!window.WebGLRenderingContext||e?P:(t=R.createElement("canvas"),(P=O(t))?t.addEventListener("webglcontextlost",function e(i){i.preventDefault(),P&&P.canvas===this&&(P=void 0,t.removeEventListener("webglcontextlost",e,!1))},!1):T.warn("Unable to access WebGL."),P)}var B=["img","canvas","video"],I=window.document;function L(e,t){var i,r,o,s;if(!(i=_(e,B)))return!1;if(!(r=I.createElement("canvas")))return T.warn("Browser does not support canvas or Seriously.js"),!1;if(0===i.naturalWidth&&"IMG"===i.tagName)return T.warn("Image not loaded"),!1;if(0===i.readyState&&0===i.videoWidth&&"VIDEO"===i.tagName)return T.warn("Video not loaded"),!1;if(o=U(t)){(s=o.createTexture())||T.error("Test WebGL context has been lost"),o.bindTexture(o.TEXTURE_2D,s);try{o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,i)}catch(e){return e.code===window.DOMException.SECURITY_ERR?T.log("Unable to access cross-domain image"):T.error("Error storing image to texture: "+e.message),o.deleteTexture(s),!1}o.deleteTexture(s)}else{o=r.getContext("2d");try{o.drawImage(i,0,0),o.getImageData(0,0,1,1)}catch(e){return e.code===window.DOMException.SECURITY_ERR?T.log("Unable to access cross-domain image"):T.error("Error drawing image to canvas: "+e.message),!1}}return!0}function M(e,t){var i=void 0,r=void 0,o=void 0;return!!t&&(i=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e.vertices,t.STATIC_DRAW),i.size=3,r=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW),o=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,e.coords,t.STATIC_DRAW),o.size=2,{vertex:i,index:r,texCoord:o,length:e.indices.length,mode:e.mode||t.TRIANGLES})}function C(e){return M({vertices:new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),indices:new Uint16Array([0,1,2,0,2,3]),coords:new Float32Array([0,0,1,0,1,1,0,1])},e)}function G(e,t,i,r){var o=void 0,s=void 0,n=void 0,a=void 0;!0===r||r&&r.useFloat;this.type=e.UNSIGNED_BYTE,o=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,o),r&&r.texture?(this.texture=r.texture,e.bindTexture(e.TEXTURE_2D,this.texture),this.ownTexture=!1):(this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.ownTexture=!0);try{this.type===e.FLOAT?(n=new Float32Array(t*i*4),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.FLOAT,n)):(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,null),this.type=e.UNSIGNED_BYTE)}catch(r){this.type=e.UNSIGNED_BYTE,n=new Uint8Array(t*i*4),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,i,0,e.RGBA,e.UNSIGNED_BYTE,n)}if(s=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,s),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,s),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.texture,0),(a=e.checkFramebufferStatus(e.FRAMEBUFFER))===e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT)throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");if(a===e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT)throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");if(a===e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS)throw new Error("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");if(a===e.FRAMEBUFFER_UNSUPPORTED)throw new Error("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");if(a!==e.FRAMEBUFFER_COMPLETE)throw new Error("Incomplete framebuffer: "+a);e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),this.gl=e,this.frameBuffer=o,this.renderBuffer=s,this.width=t,this.height=i}G.prototype.resize=function(e,t){var i=this.gl;this.width===e&&this.height===t||(this.width=e,this.height=t,i&&(i.bindTexture(i.TEXTURE_2D,this.texture),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.bindRenderbuffer(i.RENDERBUFFER,this.renderBuffer),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.texture,0),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null)))},G.prototype.destroy=function(){var e=this.gl;e&&(e.deleteFramebuffer(this.frameBuffer),e.deleteRenderbuffer(this.renderBuffer),this.ownTexture&&e.deleteTexture(this.texture)),delete this.frameBuffer,delete this.renderBuffer,delete this.texture,delete this.gl};function k(e,t,i){function r(t,i){var r=void 0;if(r=i?e.createShader(e.FRAGMENT_SHADER):e.createShader(e.VERTEX_SHADER),e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){t=t.split(/[\n\r]/);for(var o=0;o<t.length;o++)t[o]=o+1+":\t"+t[o];throw t.unshift("Error compiling "+(i?"fragment":"vertex")+" shader:"),T.error(t.join("\n")),new Error("Shader error: "+e.getShaderInfoLog(r))}return r}var o=void 0,s=void 0,u=void 0,h="",f=void 0,d=void 0,l=void 0,c=void 0,p=void 0;if(s=r(t),u=r(i,!0),o=e.createProgram(),e.attachShader(o,s),(f=e.getShaderInfoLog(s))&&(h+="Vertex shader error: "+f+"\n"),e.attachShader(o,u),(f=e.getShaderInfoLog(u))&&(h+="Fragment shader error: "+f+"\n"),e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS))throw h+=e.getProgramInfoLog(o),e.deleteProgram(o),e.deleteShader(s),e.deleteShader(u),(c=a.exec(t)||a.exec(i))&&(h="Shader = "+c[1]+"\n"+h),n.forEach(function(t){h+="\n"+t+": "+e.getParameter(e[t])}),new Error("Could not initialize shader:\n"+h);for(e.useProgram(o),this.uniforms={},l=e.getProgramParameter(o,e.ACTIVE_UNIFORMS),d=0;d<l;++d)(p={info:e.getActiveUniform(o,d)}).name=p.info.name.replace(/\[0\]$/,""),p.loc=e.getUniformLocation(o,p.name),p.set=function(t,i){if(t.type===e.SAMPLER_2D)return function(r){t.glTexture=e["TEXTURE"+r],e.uniform1i(i,r)};if(t.type===e.BOOL||t.type===e.INT)return t.size>1?function(t){e.uniform1iv(i,t)}:function(t){e.uniform1i(i,t)};if(t.type===e.FLOAT)return t.size>1?function(t){e.uniform1fv(i,t)}:function(t){e.uniform1f(i,t)};if(t.type===e.FLOAT_VEC2)return function(t){e.uniform2f(i,t[0],t[1])};if(t.type===e.FLOAT_VEC3)return function(t){e.uniform3f(i,t[0],t[1],t[2])};if(t.type===e.FLOAT_VEC4)return function(t){e.uniform4f(i,t[0],t[1],t[2],t[3])};if(t.type===e.FLOAT_MAT3)return function(t){e.uniformMatrix3fv(i,!1,t)};if(t.type===e.FLOAT_MAT4)return function(t){e.uniformMatrix4fv(i,!1,t)};throw new Error("Unknown shader uniform type: "+t.type)}(p.info,p.loc),p.get=function(t){return function(){return e.getUniform(o,t)}}(p.loc),this.uniforms[p.name]=p,this[p.name]||(this[p.name]=p);for(this.attributes={},this.location={},l=e.getProgramParameter(o,e.ACTIVE_ATTRIBUTES),d=0;d<l;++d)(p={info:e.getActiveAttrib(o,d)}).name=p.info.name,p.location=e.getAttribLocation(o,p.name),this.attributes[p.name]=p,this.location[p.name]=p.location;this.gl=e,this.program=o,this.destroy=function(){e&&(e.deleteProgram(o),e.deleteShader(s),e.deleteShader(u));for(var t in this)this.hasOwnProperty(t)&&delete this[t];o=null,s=null,u=null}}k.prototype.use=function(){this.gl.useProgram(this.program)};function z(e){this.ready=!1,this.width=1,this.height=1,this.uniforms={resolution:[this.width,this.height],transform:null},this.dirty=!0,this.isDestroyed=!1,this.seriously=e,this.gl=e.gl,this.listeners={},this.id=e.getNodeId()}z.prototype.setReady=function(){var e=void 0;if(!this.ready&&(this.ready=!0,this.emit("ready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setReady()},z.prototype.setUnready=function(){var e=void 0;if(this.ready&&(this.ready=!1,this.emit("unready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setUnready()},z.prototype.setDirty=function(){var e=void 0;if(!this.dirty&&(this.emit("dirty"),this.dirty=!0,this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setDirty()},z.prototype.initFrameBuffer=function(e){this.seriously.gl&&(this.frameBuffer=new G(this.seriously.gl,this.width,this.height,e))},z.prototype.readPixels=function(e,t,i,r,o){var s=this.seriously.gl,n=this.gl||s;if(!s)throw new Error("Cannot read pixels until a canvas is connected");if(this.frameBuffer||(this.initFrameBuffer(),this.setDirty()),this.render(),void 0===o)o=new Uint8Array(i*r*4);else if(!S(o,"Uint8Array"))throw new Error("Incompatible array type");return n.bindFramebuffer(s.FRAMEBUFFER,this.frameBuffer.frameBuffer),n.readPixels(e,t,i,r,s.RGBA,s.UNSIGNED_BYTE,o),o},z.prototype.resize=function(){var e=void 0,t=void 0;this.source?(e=this.source.width,t=this.source.height):this.sources&&this.sources.source?(e=this.sources.source.width,t=this.sources.source.height):this.inputs&&this.inputs.width?(e=this.inputs.width,t=this.inputs.height||e):this.inputs&&this.inputs.height?e=t=this.inputs.height:(e=1,t=1),e=Math.floor(e),t=Math.floor(t),this.width===e&&this.height===t||(this.width=e,this.height=t,this.emit("resize"),this.setDirty()),this.uniforms&&this.uniforms.resolution&&(this.uniforms.resolution[0]=e,this.uniforms.resolution[1]=t),this.frameBuffer&&this.frameBuffer.resize&&this.frameBuffer.resize(e,t)},z.prototype.on=function(e,t){var i=void 0,r=-1;e&&"function"==typeof t&&((i=this.listeners[e])?r=i.indexOf(t):i=this.listeners[e]=[],r<0&&i.push(t))},z.prototype.off=function(e,t){var i=void 0,r=-1;e&&"function"==typeof t&&(i=this.listeners[e])&&(r=i.indexOf(t))>=0&&i.splice(r,1)},z.prototype.emit=function(e){var t=void 0,i=this.listeners[e];if(i&&i.length)for(t=0;t<i.length;t++)F(i[t])},z.prototype.destroy=function(){var e=void 0,t=void 0;for(t in this.listeners)this.listeners.hasOwnProperty(t)&&delete this.listeners[t];for(e in this.uniforms)this.uniforms.hasOwnProperty(e)&&delete this.uniforms[e];this.targets&&delete this.targets,this.frameBuffer&&this.frameBuffer.destroy&&(this.frameBuffer.destroy(),delete this.frameBuffer),this.seriously.removeNode(this),delete this.seriously,this.isDestroyed=!0};var X=function(){};function j(e){var t=e;Object.defineProperties(this,{original:{enumerable:!0,configurable:!0,get:function(){return t.source}},id:{enumerable:!0,configurable:!0,get:function(){return t.id}},width:{enumerable:!0,configurable:!0,get:function(){return t.width}},height:{enumerable:!0,configurable:!0,get:function(){return t.height}}}),this.render=function(){t.render()},this.update=function(){t.update(),t.setDirty()},this.readPixels=function(e,i,r,o,s){return t.readPixels(e,i,r,o,s)},this.on=function(e,i){t.on(e,i)},this.off=function(e,i){t.off(e,i)},this.destroy=function(){var e=void 0,i=void 0;t.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=X)},this.isDestroyed=function(){return t.isDestroyed},this.isReady=function(){return t.ready}}function W(e,t,i,r){function o(e){return f.source===e}var s=r||{},n=void 0===s.flip||s.flip,a=s.width,u=s.height,h=!1,f=this,d=!1,l=void 0,c=void 0;if(z.call(this,e),l=this.seriously.gl,(t&&"string"!=typeof t||!i&&0!==i)&&(r&&"object"===(void 0===r?"undefined":x(r))||(r=i),i=t),"string"==typeof i&&isNaN(i)&&(i=_(i,["canvas","img","video"])),"string"==typeof t&&(c=this.seriously.constructor.sourcePlugin(this,t,i,r,!0))&&(this.hook=t,d=!0,h=c.deferTexture,this.plugin=c,this.compare=c.compare,this.checkDirty=c.checkDirty,c.source&&(i=c.source)),!c&&S(i))"CANVAS"===i.tagName?(this.width=i.width,this.height=i.height,this.render=this.renderImageCanvas.bind(this),d=!0,this.hook="canvas",this.compare=o,this.update=function(){this.width=i.width,this.height=i.height,this.resize()}):"IMG"===i.tagName&&(this.width=i.naturalWidth||1,this.height=i.naturalHeight||1,i.complete&&i.naturalWidth||(h=!0),i.addEventListener("load",function(){f.isDestroyed||(f.width===i.naturalWidth&&f.height===i.naturalHeight||(f.width=i.naturalWidth,f.height=i.naturalHeight,f.resize()),f.setDirty(),f.setReady())},!0),this.render=this.renderImageCanvas.bind(this),d=!0,this.hook="image",this.compare=o);else if(!c&&S(i,"WebGLTexture")){if(l&&!l.isTexture(i))throw new Error("Not a valid WebGL texture.");isNaN(a)?isNaN(u)||(a=u):isNaN(u)&&(u=a),this.width=a,this.height=u,void 0===s.flip&&(n=!1),d=!0,this.texture=i,this.initialized=!0,this.hook="texture",this.compare=o,this.render=function(){}}if(d||c||this.seriously.constructor.forEachSource(function(e,t){if(t=this.seriously.constructor.sourcePlugin(this,e,i,r,!1))return this.hook=e,d=!0,h=t.deferTexture,this.plugin=t,this.compare=t.compare,this.checkDirty=t.checkDirty,t.source&&(i=t.source),!1}.bind(this)),!d)throw new Error("Unknown source type");this.source=i,void 0===this.flip&&(this.flip=n),this.targets=[],h||f.setReady(),this.pub=new j(this),e.addSourceNode(this)}W.prototype=Object.create(z.prototype),W.prototype.constructor=W,W.prototype.initialize=function(){var e=this.seriously.gl,t=void 0;e&&!this.texture&&this.ready&&(t=e.createTexture(),e.bindTexture(e.TEXTURE_2D,t),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),this.texture=t,this.initialized=!0,this.allowRefresh=!0,this.setDirty())},W.prototype.initFrameBuffer=function(e){var t=this.seriously.gl;t&&(this.frameBuffer=new G(t,this.width,this.height,{texture:this.texture,useFloat:e}))},W.prototype.addTarget=function(e){var t=void 0;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},W.prototype.removeTarget=function(e){var t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1)},W.prototype.update=X,W.prototype.resize=function(){var e=void 0,t=void 0;if(this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.framebuffer&&this.framebuffer.resize(this.width,this.height),this.emit("resize"),this.setDirty(),this.targets)for(e=0;e<this.targets.length;e++)(t=this.targets[e]).resize(),t.setTransformDirty&&t.setTransformDirty()},W.prototype.setReady=function(){var e=void 0;if(!this.ready&&(this.ready=!0,this.resize(),this.initialize(),this.emit("ready"),this.targets))for(e=0;e<this.targets.length;e++)this.targets[e].setReady()},W.prototype.render=function(){var e=this.seriously.gl,t=this.source;e&&(t||0===t)&&this.ready&&(this.initialized||this.initialize(),this.allowRefresh&&this.plugin&&this.plugin.render&&(this.dirty||this.checkDirty&&this.checkDirty())&&this.plugin.render.call(this,e,this.seriously.draw,this.seriously.rectangleModel,this.seriously.baseShader)&&(this.dirty=!1,this.emit("render")))},W.prototype.renderImageCanvas=function(){var e=this.seriously.gl,t=this.source;if(e&&t&&this.ready&&(this.initialized||this.initialize(),this.allowRefresh&&this.dirty)){e.bindTexture(e.TEXTURE_2D,this.texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flip),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);try{return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.dirty=!1,this.emit("render"),!0}catch(e){e.code===window.DOMException.SECURITY_ERR&&(this.allowRefresh=!1,T.error("Unable to access cross-domain image"))}return!1}},W.prototype.destroy=function(){var e=void 0,t=void 0;for(this.plugin&&this.plugin.destroy&&this.plugin.destroy.call(this),this.seriously.gl&&this.texture&&this.seriously.gl.deleteTexture(this.texture);this.targets.length;)(t=this.targets.pop())&&t.removeSource&&t.removeSource(this);this.seriously.removeSourceNode(this),z.prototype.destroy.call(this);for(e in this)this.hasOwnProperty(e)&&"id"!==e&&"isDestroyed"!==e&&delete this[e]};var V=function(){};function H(e){function t(e,t){var i=r.effect.inputs[e],o=r.inputElements[e],s=void 0;return"string"==typeof t&&isNaN(t)&&("enum"===i.type?i.options.hasOwnProperty(t)||(t=_(t,["select"])):"number"===i.type||"boolean"===i.type?t=_(t,["input","select"]):"image"===i.type&&(t=_(t,["canvas","img","video"]))),S(t,"HTMLInputElement")||S(t,"HTMLSelectElement")?(s=t.value,o&&o.element!==t&&(o.element.removeEventListener("change",o.listener,!0),o.element.removeEventListener("input",o.listener,!0),delete r.inputElements[e],o=null),o||(o={element:t,listener:function(e,o){return function(){var s=void 0,n=void 0;s="checkbox"===t.type?t.checked:o.value,n=r.setInput(e,s),"color"===i.type&&(n=y(n).substr(0,7)),n!==s&&(o.value=n)}}(e,t)},r.inputElements[e]=o,"range"===t.type?(t.addEventListener("input",o.listener,!0),t.addEventListener("change",o.listener,!0)):t.addEventListener("change",o.listener,!0)),o&&"checkbox"===t.type&&(s=t.checked)):(o&&(o.element.removeEventListener("change",o.listener,!0),o.element.removeEventListener("input",o.listener,!0),delete r.inputElements[e]),s=t),r.setInput(e,s),r.inputs[e]}var i=void 0,r=e;for(i in r.effect.inputs)if(r.effect.inputs.hasOwnProperty(i)){if(void 0!==this[i])throw new Error("Cannot overwrite Seriously."+i);"image"===r.effect.inputs[i].type?Object.defineProperty(this,i,{configurable:!0,enumerable:!0,get:function(e){return function(){var t=r.inputs[e];return t&&t.pub}}(i),set:function(e){return function(i){var r=t(e,i);return r&&r.pub}}(i)}):Object.defineProperty(this,i,{configurable:!0,enumerable:!0,get:function(e){return function(){return r.inputs[e]}}(i),set:function(e){return function(i){return t(e,i)}}(i)})}Object.defineProperties(this,{effect:{enumerable:!0,configurable:!0,get:function(){return r.hook}},title:{enumerable:!0,configurable:!0,get:function(){return r.effect.title||r.hook}},width:{enumerable:!0,configurable:!0,get:function(){return r.width}},height:{enumerable:!0,configurable:!0,get:function(){return r.height}},id:{enumerable:!0,configurable:!0,get:function(){return r.id}}}),this.render=function(){return r.render(),this},this.readPixels=function(e,t,i,o,s){return r.readPixels(e,t,i,o,s)},this.on=function(e,t){r.on(e,t)},this.off=function(e,t){r.off(e,t)},this.inputs=function(e){var t=void 0,i=void 0,o=r.effect.inputs,s=void 0;if(e)return(i=o[e])?(t={type:i.type,defaultValue:i.defaultValue,title:i.title||e},"number"===i.type?(t.min=i.min,t.max=i.max,t.step=i.step,t.mod=i.mod):"enum"===i.type?t.options=p({},i.options):"vector"===i.type&&(t.dimensions=i.dimensions),i.description&&(t.description=i.description),t):null;t={};for(s in o)o.hasOwnProperty(s)&&(t[s]=this.inputs(s));return t},this.alias=function(e,t){return r.alias(e,t),this},this.matte=function(e){r.matte(e)},this.destroy=function(){var e=void 0,t=void 0;r.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((t=Object.getOwnPropertyDescriptor(this,e)).get||t.set||"function"!=typeof this[e]?delete this[e]:this[e]=V)},this.isDestroyed=function(){return r.isDestroyed},this.isReady=function(){return r.ready}}function Y(e,t,i,r){var o=void 0,s=void 0,n=void 0,a=void 0,u={};z.call(this,e),this.effectRef=i,this.sources={},this.targets=[],this.inputElements={},this.dirty=!0,this.shaderDirty=!0,this.hook=t,this.options=r,this.transform=null,this.effect=p({},this.effectRef),this.effectRef.definition&&p(this.effect,this.effectRef.definition.call(this,r)),Seriously.validateInputSpecs(this.effect),this.uniforms.transform=c,this.inputs={},a=e.defaults(t);for(o in this.effect.inputs)this.effect.inputs.hasOwnProperty(o)&&(void 0!==(s=this.effect.inputs[o]).defaultValue&&null!==s.defaultValue||("number"===s.type?s.defaultValue=Math.min(Math.max(0,s.min),s.max):"color"===s.type?s.defaultValue=[0,0,0,0]:"boolean"===s.type?s.defaultValue=!1:"string"===s.type?s.defaultValue="":"enum"===s.type&&(s.defaultValue=s.firstValue)),n=s.validate.call(this,s.defaultValue,s),a&&void 0!==a[o]&&(n=s.validate.call(this,a[o],s,s.defaultValue,n),a[o]=n,"image"===s.type&&(u[o]=n)),this.inputs[o]=n,s.uniform&&(this.uniforms[s.uniform]=s.defaultValue));this.seriously.gl&&(this.initialize(),this.effect.commonShader&&this.buildShader()),this.updateReady(),this.inPlace=this.effect.inPlace,this.pub=new H(this),e.addEffectNode(this);for(o in u)u.hasOwnProperty(o)&&this.setInput(o,u[o])}Y.prototype=Object.create(z.prototype),Y.prototype.constructor=Y,Y.prototype.initialize=function(){this.initialized||(this.baseShader=this.seriously.baseShader,this.shape?this.model=M(this.shape,this.gl):this.model=this.seriously.rectangleModel,"function"==typeof this.effect.initialize?this.effect.initialize.call(this,function(){this.initFrameBuffer(!0)}.bind(this),this.seriously.gl):this.initFrameBuffer(!0),this.frameBuffer&&(this.texture=this.frameBuffer.texture),this.initialized=!0)},Y.prototype.resize=function(){var e=void 0;for(z.prototype.resize.call(this),this.effect.resize&&this.effect.resize.call(this),e=0;e<this.targets.length;e++)this.targets[e].resize()},Y.prototype.updateReady=function(){var e=void 0,t=void 0,i=void 0,r=!0,o=void 0;i=this.effect;for(t in i.inputs)if(i.inputs.hasOwnProperty(t)&&"image"===this.effect.inputs[t].type&&(!this.sources[t]||!this.sources[t].ready)&&(!i.requires||i.requires.call(this,t,this.inputs))){r=!1;break}if(this.ready!==r&&(this.ready=r,this.emit(r?"ready":"unready"),o=r?"setReady":"setUnready",this.targets))for(e=0;e<this.targets.length;e++)this.targets[e][o]()},Y.prototype.setReady=Y.prototype.updateReady,Y.prototype.setUnready=Y.prototype.updateReady,Y.prototype.addTarget=function(e){var t=void 0;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},Y.prototype.removeTarget=function(e){var t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1)},Y.prototype.removeSource=function(e){var t=void 0,i=e&&e.pub;for(t in this.inputs)!this.inputs.hasOwnProperty(t)||this.inputs[t]!==e&&this.inputs[t]!==i||(this.inputs[t]=null);for(t in this.sources)!this.sources.hasOwnProperty(t)||this.sources[t]!==e&&this.sources[t]!==i||(this.sources[t]=null)},Y.prototype.buildShader=function(){function e(e){return a.test(e)?e:"#define SHADER_NAME seriously."+r+"\n"+e}var t=void 0,i=this.effect,r=this.hook;this.shaderDirty&&(i.commonShader&&this.seriously.commonShaders[this.hook]?(this.shader||this.seriously.commonShaders[this.hook].count++,this.shader=this.seriously.commonShaders[this.hook].shader):i.shader?(this.shader&&!i.commonShader&&this.shader.destroy(),(t=i.shader.call(this,this.inputs,{vertex:d,fragment:l},this.seriously.constructor.util))instanceof k?this.shader=t:t&&t.vertex&&t.fragment?this.shader=new k(this.seriously.gl,e(t.vertex),e(t.fragment)):this.shader=this.seriously.baseShader,i.commonShader&&(this.seriously.commonShaders[this.hook]={count:1,shader:this.shader})):this.shader=this.seriously.baseShader,this.shaderDirty=!1)},Y.prototype.render=function(){var e=void 0,t=void 0,i=this.effect,r=this,o=void 0;if(this.seriously.gl){if(this.initialized||this.initialize(),this.shaderDirty&&this.buildShader(),this.dirty&&this.ready){for(e in this.sources)!this.sources.hasOwnProperty(e)||i.requires&&!i.requires.call(this,e,this.inputs)||(o="function"==typeof this.inPlace?this.inPlace(e):this.inPlace,this.sources[e].render(!o));this.frameBuffer&&(t=this.frameBuffer.frameBuffer),"function"==typeof i.draw?(i.draw.call(this,this.shader,this.model,this.uniforms,t,function(e,t,i,o,s,n){r.seriously.draw(e,t,i,o,s||r,n)}),this.emit("render")):t&&(this.seriously.draw(this.shader,this.model,this.uniforms,t,this),this.emit("render")),this.dirty=!1}return this.texture}},Y.prototype.setInput=function(e,t){var i=void 0,r=void 0,o=void 0,s=void 0,n=this,a=void 0;if(this.effect.inputs.hasOwnProperty(e)){if("image"===(i=this.effect.inputs[e]).type){if(t){if((t=this.seriously.findInputNode(t))!==this.sources[e]){if(function(){var t=n.sources[e],i=void 0;if(t){for(i in n.sources)if(i!==e&&n.sources.hasOwnProperty(i)&&n.sources[i]===t)return;t.removeTarget(n)}}(),this.seriously.constructor.traceSources(t,this))throw new Error("Attempt to make cyclical connection.");this.sources[e]=t,t.addTarget(this)}}else delete this.sources[e],t=!1;r=this.sources[e],o=Object.keys(this.sources),!0===this.inPlace&&1===o.length?(s=this.sources[o[0]],this.uniforms.transform=s&&s.cumulativeMatrix||c):this.uniforms.transform=c}else{var u=this.seriously.defaults(this.hook);a=u&&void 0!==u[e]?u[e]:i.defaultValue,r=t=i.validate.call(this,t,i,a,this.inputs[e])}return this.inputs[e]===t&&"color"!==i.type&&"vector"!==i.type?t:(this.inputs[e]=t,i.uniform&&(this.uniforms[i.uniform]=r),"image"===i.type?(this.resize(),this.updateReady()):i.updateSources&&this.updateReady(),i.shaderDirty&&(this.shaderDirty=!0),this.setDirty(),i.update&&i.update.call(this,t),t)}},Y.prototype.alias=function(e,t){var i=this;if(f.indexOf(t)>=0)throw new Error("'"+t+"' is a reserved name and cannot be used as an alias.");return this.effect.inputs.hasOwnProperty(e)&&(t||(t=e),this.seriously.removeAlias(t),this.seriously.addAlias(t,{node:this,input:e}),Object.defineProperty(this.seriously,t,{configurable:!0,enumerable:!0,get:function(){return i.inputs[e]},set:function(t){return i.setInput(e,t)}})),this},Y.prototype.matte=function(e){function t(e,t,i,r){var o=(r.x-i.x)*(e.y-i.y)-(r.y-i.y)*(e.x-i.x),s=(t.x-e.x)*(e.y-i.y)-(t.y-e.y)*(e.x-i.x),n=(r.y-i.y)*(t.x-e.x)-(r.x-i.x)*(t.y-e.y);if(n){var a=o/n,u=s/n;if(a>0&&a<=1&&u>0&&u<=1)return{x:e.x+a*(t.x-e.x),y:e.y+a*(t.y-e.y)}}return!1}var i=void 0,r=[],o=void 0,s=[],n=void 0,a=void 0,u=void 0,h=void 0,f=void 0,d={};for(i=function(e){return e&&e.length&&Array.isArray(e)?Array.isArray(e[0])?Array.isArray(e[0])&&!isNaN(e[0][0])?[e]:e:[e]:[]}(e),n=0;n<i.length;n++){for(e=i[n],f=null,o={vertices:[],edges:[]},a=0;a<e.length;a++)"object"!==(void 0===(u=e[a])?"undefined":x(u))||isNaN(u.x)||isNaN(u.y)?u.length>=2&&!isNaN(u[0])&&!isNaN(u[1])&&(h={x:u[0],y:u[1],id:s.length}):h={x:u.x,y:u.y,id:s.length},h&&(f?(f.next=h,h.prev=f,h.next=o.vertices[0],o.vertices[0].prev=h):(o.head=h,h.next=h,h.prev=h),s.push(h),o.vertices.push(h),f=h);if(o.vertices.length>2)for(3===o.vertices.length&&(o.simple=!0),r.push(o),a=0;a<o.vertices.length;a++)h=o.vertices[a],o.edges.push([h,h.next])}for(n=r.length-1;n>=0;n--)!function(e){var i=void 0,o=void 0,n=void 0,a=void 0,u=void 0,h=[],f=void 0,d=void 0,l=void 0,c=void 0,p=void 0,m=void 0;if(!e.simple){for(i=0;i<e.edges.length;i++)for(n=e.edges[i],o=i+1;o<e.edges.length;o++)a=e.edges[o],(u=t(n[0],n[1],a[0],a[1]))&&(u.edge1=n,u.edge2=a,h.push(u));if(h.length){for(c=[],i=0;i<h.length;i++)n=(u=h[i]).edge1,a=u.edge2,p={x:u.x,y:u.y,prev:n[0],next:a[1],id:s.length},e.vertices.push(p),s.push(p),m={x:u.x,y:u.y,prev:a[0],next:n[1],id:s.length},e.vertices.push(m),s.push(p),p.prev.next=p,p.next.prev=p,m.prev.next=m,m.next.prev=m;do{f={edges:[],vertices:[],simple:!0},c.push(f),d=l=e.vertices[0];do{i=e.vertices.indexOf(l),e.vertices.splice(i,1),f.edges.push([l,l.next]),f.vertices.push(l),l=l.next}while(l!==d)}while(e.vertices.length);for(i=r.indexOf(e),r.splice(i,1),i=0;i<c.length;i++)r.push(c[i])}else e.simple=!0}}(o=r[n]);for(n=0;n<r.length;n++)(o=r[n]).clockWise=function(e){var t=void 0,i=void 0,r=e.vertices.length,o=void 0,s=void 0,n=0;for(t=r-1,i=0;i<r;t=i,i++)o=e.vertices[t],s=e.vertices[i],n+=o.x*s.y-s.x*o.y;return n>0}(o),function(e){function t(e,t,i,r){var o=void 0,s=void 0,n=void 0,a=void 0,u=void 0,h=void 0,f=void 0,d=void 0,l=void 0,c=void 0,p=void 0,m=void 0,g=void 0,v=void 0,y=void 0;return o=i.x-t.x,s=i.y-t.y,n=e.x-i.x,a=e.y-i.y,u=t.x-e.x,h=t.y-e.y,f=r.x-e.x,d=r.y-e.y,l=r.x-t.x,c=r.y-t.y,p=r.x-i.x,m=r.y-i.y,y=o*c-s*l,g=u*d-h*f,v=n*m-a*p,y>=0&&v>=0&&g>=0}var i=void 0,r=e.vertices,s=void 0,n=[],a=[],u=void 0,h=void 0,f=void 0,d=void 0,l=void 0,c=void 0,p=void 0,m=void 0,g=void 0;if(s=r.length,e.clockWise)for(i=0;i<s;i++)n[i]=i;else for(i=0;i<s;i++)n[i]=s-1-i;for(h=2*(u=s),i=u-1;u>2;){if(h--<=0)return a;if(f=i,u<=f&&(f=0),i=f+1,u<=i&&(i=0),d=i+1,u<d&&(d=0),function(e,i,o,s,n){var a=void 0,u=void 0,h=void 0,f=void 0,d=void 0;if(u=r[n[e]],h=r[n[i]],f=r[n[o]],0>(h.x-u.x)*(f.y-u.y)-(h.y-u.y)*(f.x-u.x))return!1;for(a=0;a<s;a++)if(a!==e&&a!==i&&a!==o&&(d=r[n[a]],t(u,h,f,d)))return!1;return!0}(f,i,d,u,n)){for(l=n[f],c=n[i],p=n[d],e.clockWise?(a.push(r[l]),a.push(r[c]),a.push(r[p])):(a.push(r[p]),a.push(r[c]),a.push(r[l])),m=i,g=i+1;g<u;m++,g++)n[m]=n[g];h=2*--u}}o.indices=a}(o);for(d.vertices=[],d.coords=[],n=0;n<s.length;n++)u=s[n],d.vertices.push(2*u.x-1),d.vertices.push(-2*u.y+1),d.vertices.push(-1),d.coords.push(u.x),d.coords.push(-1*u.y+1);for(d.vertices=new Float32Array(d.vertices),d.coords=new Float32Array(d.coords),d.indices=[],n=0;n<r.length;n++)for(o=r[n],a=0;a<o.indices.length;a++)u=o.indices[a],d.indices.push(u.id);d.indices=new Uint16Array(d.indices),this.shape=d,this.gl&&M(d,this.gl)},Y.prototype.destroy=function(){var e=this.seriously.commonShaders,t=void 0,i=void 0,r=this.hook;this.effect.destroy&&"function"==typeof this.effect.destroy&&this.effect.destroy.call(this),delete this.effect,e[r]&&(e[r].count--,e[r].count||delete e[r]),this.shader&&this.shader.destroy&&this.shader!==this.seriously.baseShader&&!e[r]&&this.shader.destroy(),delete this.shader;for(t in this.inputElements)this.inputElements.hasOwnProperty(t)&&((i=this.inputElements[t]).element.removeEventListener("change",i.listener,!0),i.element.removeEventListener("input",i.listener,!0));for(t in this.sources)this.sources.hasOwnProperty(t)&&((i=this.sources[t])&&i.removeTarget&&i.removeTarget(this),delete this.sources[t]);for(;this.targets.length;)(i=this.targets.pop())&&i.removeSource&&i.removeSource(this);this.seriously.removeEffectNode(this),z.prototype.destroy.call(this);for(t in this)this.hasOwnProperty(t)&&"id"!==t&&"isDestroyed"!==t&&delete this[t]};var q=function(){};function K(e){function t(e,t,r){var o=void 0,s=void 0;o=i.inputElements[e],"string"==typeof r&&isNaN(r)&&("enum"===t.type?t.options.hasOwnProperty(r)||(r=_(r,["select"])):"number"===t.type||"boolean"===t.type?r=_(r,["input","select"]):"image"===t.type&&(r=_(r,["canvas","img","video"]))),S(r,"HTMLInputElement")||S(r,"HTMLSelectElement")?(s=r.value,o&&o.element!==r&&(o.element.removeEventListener("change",o.listener,!0),o.element.removeEventListener("input",o.listener,!0),delete i.inputElements[e],o=null),o||(o={element:r,listener:function(t){return function(){var o=void 0,s=void 0;o="checkbox"===r.type?r.checked:t.value,s=i.setInput(e,o),"color"===r.type&&(s=y(s)),s!==o&&(t.value=s)}}(r)},i.inputElements[e]=o,"range"===r.type?(r.addEventListener("input",o.listener,!0),r.addEventListener("change",o.listener,!0)):r.addEventListener("change",o.listener,!0)),o&&"checkbox"===r.type&&(s=r.checked)):(o&&(o.element.removeEventListener("change",o.listener,!0),o.element.removeEventListener("input",o.listener,!0),delete i.inputElements[e]),s=r),i.setInput(e,s)}var i=e,r=this,o=void 0;Object.defineProperties(this,{transform:{enumerable:!0,configurable:!0,get:function(){return i.hook}},title:{enumerable:!0,configurable:!0,get:function(){return i.plugin.title||i.hook}},width:{enumerable:!0,configurable:!0,get:function(){return i.width}},height:{enumerable:!0,configurable:!0,get:function(){return i.height}},id:{enumerable:!0,configurable:!0,get:function(){return i.id}},source:{enumerable:!0,configurable:!0,get:function(){return i.source&&i.source.pub},set:function(e){i.setSource(e)}}});for(o in i.methods)i.methods.hasOwnProperty(o)&&(this[o]=function(e){return function(){e.apply(i,arguments)&&i.setTransformDirty()}}(i.methods[o]));for(o in i.inputs)i.inputs.hasOwnProperty(o)&&function(e,o){Object.defineProperty(r,e,{configurable:!0,enumerable:!0,get:function(){return o.get.call(i)},set:function(i){t(e,o,i)}})}(o,i.inputs[o]);this.update=function(){i.setDirty()},this.inputs=function(e){var t=void 0,r=void 0,o=void 0,s=void 0;if(o=i.plugin.inputs,e)return!(r=o[e])||r.method?null:(t={type:r.type,defaultValue:r.defaultValue,title:r.title||e},"number"===r.type?(t.min=r.min,t.max=r.max,t.step=r.step,t.mod=r.mod):"enum"===r.type?t.options=p({},r.options):"vector"===r.type&&(t.dimensions=r.dimensions),r.description&&(t.description=r.description),t);t={};for(s in o)o.hasOwnProperty(s)&&!o[s].method&&(t[s]=this.inputs(s));return t},this.alias=function(e,t){return i.alias(e,t),this},this.on=function(e,t){i.on(e,t)},this.off=function(e,t){i.off(e,t)},this.destroy=function(){var e=void 0,t=void 0;i.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((t=Object.getOwnPropertyDescriptor(this,e)).get||t.set||"function"!=typeof this[e]?delete this[e]:this[e]=q)},this.isDestroyed=function(){return i.isDestroyed},this.isReady=function(){return i.ready}}function Z(e,t,i,r){var o=void 0,s=void 0,n=void 0,a=void 0,u=void 0;this.matrix=new Float32Array(16),this.cumulativeMatrix=new Float32Array(16),this.ready=!1,this.width=1,this.height=1,this.seriously=e,this.gl=e.gl,this.transformRef=i,this.hook=t,this.id=e.getNodeId(),this.options=r,this.sources=null,this.targets=[],this.inputElements={},this.inputs={},this.methods={},this.listeners={},this.texture=null,this.frameBuffer=null,this.uniforms=null,this.dirty=!0,this.transformDirty=!0,this.renderDirty=!1,this.isDestroyed=!1,this.transformed=!1,this.plugin=p({},this.transformRef),this.transformRef.definition&&p(this.plugin,this.transformRef.definition.call(this,r));for(o in this.plugin.inputs)this.plugin.inputs.hasOwnProperty(o)&&((s=this.plugin.inputs[o]).method&&"function"==typeof s.method?this.methods[o]=s.method:"function"==typeof s.set&&"function"==typeof s.get&&(this.inputs[o]=s));Seriously.validateInputSpecs(this.plugin),u=e.defaults(t);for(o in this.plugin.inputs)this.plugin.inputs.hasOwnProperty(o)&&"function"==typeof(s=this.plugin.inputs[o]).set&&"function"==typeof s.get&&"function"!=typeof s.method&&(n=s.get.call(this),a=void 0===s.defaultValue?n:s.defaultValue,a=s.validate.call(this,a,s,n),u&&void 0!==u[o]&&(a=s.validate.call(this,u[o],s,s.defaultValue,a),u[o]=a),a!==n&&s.set.call(this,a));this.pub=new K(this),e.addTransformNode(this)}Z.prototype=Object.create(z.prototype),Z.prototype.constructor=Z,Z.prototype.setDirty=function(){this.renderDirty=!0,z.prototype.setDirty.call(this)},Z.prototype.setTransformDirty=function(){var e=void 0,t=void 0;for(this.transformDirty=!0,this.dirty=!0,this.renderDirty=!0,e=0;e<this.targets.length;e++)(t=this.targets[e]).setTransformDirty?t.setTransformDirty():t.setDirty()},Z.prototype.resize=function(){var e=void 0;for(z.prototype.resize.call(this),this.plugin.resize&&this.plugin.resize.call(this),e=0;e<this.targets.length;e++)this.targets[e].resize();this.setTransformDirty()},Z.prototype.setSource=function(e){var t=void 0;if((t=this.seriously.findInputNode(e))!==this.source){if(this.seriously.constructor.traceSources(t,this))throw new Error("Attempt to make cyclical connection.");this.source&&this.source.removeTarget(this),this.source=t,t.addTarget(this),t&&t.ready?this.setReady():this.setUnready(),this.resize()}},Z.prototype.addTarget=function(e){var t=void 0;for(t=0;t<this.targets.length;t++)if(this.targets[t]===e)return;this.targets.push(e)},Z.prototype.removeTarget=function(e){var t=this.targets&&this.targets.indexOf(e);t>=0&&this.targets.splice(t,1),this.targets&&this.targets.length&&this.resize()},Z.prototype.setInput=function(e,t){var i=this.seriously.defaults(this.hook),r=void 0,o=void 0,s=void 0;if(this.plugin.inputs.hasOwnProperty(e))return r=this.plugin.inputs[e],o=i&&void 0!==i[e]?i[e]:r.defaultValue,s=r.get.call(this),void 0===o&&(o=s),t=r.validate.call(this,t,r,o,s),r.set.call(this,t)&&this.setTransformDirty(),r.get.call(this)},Z.prototype.alias=function(e,t){var i=this,r=void 0,o=void 0;if(f.indexOf(t)>=0)throw new Error("'"+t+"' is a reserved name and cannot be used as an alias.");return this.plugin.inputs.hasOwnProperty(e)&&(t||(t=e),this.seriously.removeAlias(t),(r=this.inputs[e])?(o=i.inputs[e],Object.defineProperty(this.seriously,t,{configurable:!0,enumerable:!0,get:function(){return o.get.call(i)},set:function(e){o.set.call(i,e)&&i.setTransformDirty()}})):(r=this.methods[e])&&(o=r,this.seriously[t]=function(){o.apply(i,arguments)&&i.setTransformDirty()}),r&&this.seriously.addAlias(t,{node:this,input:e})),this},Z.prototype.render=function(e){var t=this.seriously.gl;return this.source?(this.source.render(),this.transformDirty&&(this.transformed?this.source.cumulativeMatrix?g.multiply(this.cumulativeMatrix,this.matrix,this.source.cumulativeMatrix):g.copy(this.cumulativeMatrix,this.matrix):g.copy(this.cumulativeMatrix,this.source.cumulativeMatrix||c),this.transformDirty=!1),e&&t?(this.renderDirty&&(this.frameBuffer||(this.uniforms={resolution:[this.width,this.height]},this.frameBuffer=new G(t,this.width,this.height)),this.uniforms.source=this.source.texture,this.uniforms.transform=this.cumulativeMatrix||c,this.seriously.draw(this.seriously.baseShader,this.seriously.rectangleModel,this.uniforms,this.frameBuffer.frameBuffer,this),this.renderDirty=!1),this.texture=this.frameBuffer.texture):this.source?this.texture=this.source.texture:this.texture=null,this.dirty=!1,this.texture):(this.transformDirty&&(g.copy(this.cumulativeMatrix,this.matrix),this.transformDirty=!1),this.texture=null,void(this.dirty=!1))},Z.prototype.readPixels=function(e,t,i,r,o){var s=this.seriously.gl,n=this.gl||s;if(!n)throw new Error("Cannot read pixels until a canvas is connected");if(this.render(!0),void 0===o)o=new Uint8Array(i*r*4);else if(!S(o,"Uint8Array"))throw new Error("Incompatible array type");return n.bindFramebuffer(s.FRAMEBUFFER,this.frameBuffer.frameBuffer),n.readPixels(e,t,i,r,s.RGBA,s.UNSIGNED_BYTE,o),o},Z.prototype.destroy=function(){var e=void 0,t=void 0,i=void 0;this.plugin.destroy&&"function"==typeof this.plugin.destroy&&this.plugin.destroy.call(this),delete this.effect,this.frameBuffer&&(this.frameBuffer.destroy(),delete this.frameBuffer,delete this.texture);for(e in this.inputElements)this.inputElements.hasOwnProperty(e)&&((i=this.inputElements[e]).element.removeEventListener("change",i.listener,!0),i.element.removeEventListener("input",i.listener,!0));for(this.source&&this.source.removeTarget(this);this.targets.length;)(i=this.targets.pop())&&i.removeSource&&i.removeSource(this);this.seriously.removeTransformNode(this),z.prototype.destroy.call(this);for(t in this)this.hasOwnProperty(t)&&"id"!==t&&"isDestroyed"!==t&&delete this[t]};var $=function(){};function J(e){var t=e;Object.defineProperties(this,{source:{enumerable:!0,configurable:!0,get:function(){if(t.source)return t.source.pub},set:function(e){t.setSource(e)}},original:{enumerable:!0,configurable:!0,get:function(){return t.target}},width:{enumerable:!0,configurable:!0,get:function(){return t.width},set:function(e){!isNaN(e)&&e>0&&t.width!==e&&(t.width=e,t.resize(),t.setTransformDirty())}},height:{enumerable:!0,configurable:!0,get:function(){return t.height},set:function(e){!isNaN(e)&&e>0&&t.height!==e&&(t.height=e,t.resize(),t.setTransformDirty())}},id:{enumerable:!0,configurable:!0,get:function(){return t.id}}}),this.render=function(){t.render()},this.readPixels=function(e,i,r,o,s){return t.readPixels(e,i,r,o,s)},this.on=function(e,i){t.on(e,i)},this.off=function(e,i){t.off(e,i)},this.go=function(e){t.go(e)},this.stop=function(){t.stop()},this.getTexture=function(){return t.frameBuffer.texture},this.destroy=function(){var e=void 0,i=void 0;t.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((i=Object.getOwnPropertyDescriptor(this,e)).get||i.set||"function"!=typeof this[e]?delete this[e]:this[e]=$)},this.inputs=function(e){return{source:{type:"image"}}},this.isDestroyed=function(){return t.isDestroyed},this.isReady=function(){return t.ready}}function Q(e,t,i,r){function o(t,i,r,o){var s=e.getTarget(t);if(s.definition){if(!(s=s.definition.call(f,i,r,o)))return null;s=p(p({},e.getTarget(t)),s),f.hook=y,c=!0,f.plugin=s,f.compare=s.compare,s.target&&(i=s.target),s.gl&&!f.gl&&(f.gl=s.gl,e.gl||e.attachContext(s.gl)),f.gl===e.gl&&(f.model=e.rectangleModel,f.shader=e.baseShader)}return s}var s=void 0,n=void 0,a=void 0,u=void 0,h=void 0,f=this,c=!1,m=void 0,g=void 0,v=void 0,y=void 0;if(z.call(this,e),h=e.gl,(t&&"string"!=typeof t||!i&&0!==i)&&(r&&"object"===(void 0===r?"undefined":x(r))||(r=i),i=t),s=r||{},n=void 0===s.flip||s.flip,a=parseInt(s.width,10),u=parseInt(s.height,10),g=s.debugContext,"string"==typeof t&&e.hasTarget(t)&&e.targetPlugin(t,i,s,!0),this.renderToTexture=s.renderToTexture,S(i,"WebGLFramebuffer"))if(v=i,S(s,"HTMLCanvasElement"))i=s;else if(S(s,"WebGLRenderingContext"))i=s.canvas;else if(S(s.canvas,"HTMLCanvasElement"))i=s.canvas;else{if(!S(s.context,"WebGLRenderingContext"))throw new Error("Must provide a canvas with WebGLFramebuffer target");i=s.context.canvas}if(S(i,"HTMLCanvasElement")){if(a=i.width,u=i.height,(!h||h.canvas!==i&&s.allowSecondaryWebGL)&&(m=O(i,{alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!0,debugContext:g})),m)h&&h!==m?(this.gl=m,this.frameBuffer={frameBuffer:v||null},this.shader=new k(this.gl,d,l),this.model=C(this.gl),this.pixels=null,this.texture=this.gl.createTexture(),this.gl.bindTexture(h.TEXTURE_2D,this.texture),this.gl.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.LINEAR),this.gl.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.LINEAR),this.gl.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),this.gl.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.render=this.renderSecondaryWebGL):(this.seriously.primaryTarget||(this.seriously.primaryTarget=this),h||e.attachContext(m),this.render=this.renderWebGL,s.renderToTexture?h&&(this.frameBuffer=new G(h,a,u,!1)):this.frameBuffer={frameBuffer:v||null});else{if(!s.allowSecondaryWebGL&&h&&h.canvas!==i)throw new Error("Only one WebGL target canvas allowed. Set allowSecondaryWebGL option to create secondary context.");this.render=$,T.log("Unable to create WebGL context.")}c=!0}if(c||e.constructor.forEachTarget(function(e){if(o(e,i,s,!1))return y=e,!1}),!c)throw new Error("Unknown target type");this.target=i,this.transform=null,this.transformDirty=!0,this.flip=n,a&&(this.width=a),u&&(this.height=u),this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.auto=void 0!==s.auto?s.auto:e.auto,this.frames=0,this.pub=new J(this),e.addTargetNode(this)}Q.prototype=Object.create(z.prototype),Q.prototype.constructor=Q,Q.prototype.setSource=function(e){var t=void 0;(t=this.seriously.findInputNode(e))!==this.source&&(this.source&&this.source.removeTarget(this),this.source=t,t.addTarget(this),t&&(this.resize(),t.ready?this.setReady():this.setUnready()),this.setDirty())},Q.prototype.setDirty=function(){this.dirty=!0,this.auto&&this.seriously.initDaemon()},Q.prototype.resize=function(){S(this.target,"HTMLCanvasElement")?this.width===this.target.width&&this.height===this.target.height||(this.target.width=this.width,this.target.height=this.height,this.uniforms.resolution[0]=this.width,this.uniforms.resolution[1]=this.height,this.emit("resize"),this.setTransformDirty()):this.plugin&&this.plugin.resize&&this.plugin.resize.call(this),!this.source||this.source.width===this.width&&this.source.height===this.height||this.transform||(this.transform=new Float32Array(16))},Q.prototype.setTransformDirty=function(){this.transformDirty=!0,this.setDirty()},Q.prototype.go=function(){this.auto=!0,this.setDirty()},Q.prototype.stop=function(){this.auto=!1},Q.prototype.render=function(){this.seriously.gl&&this.plugin&&this.plugin.render&&this.plugin.render.call(this,this.seriously.draw.bind(this.seriously),this.seriously.baseShader,this.seriously.rectangleModel)},Q.prototype.renderWebGL=function(){var e=void 0,t=void 0,i=void 0;if(this.resize(),this.seriously.gl&&this.dirty&&this.ready){if(!this.source)return;this.source.render(),this.uniforms.source=this.source.texture,this.source.width===this.width&&this.source.height===this.height?this.uniforms.transform=this.source.cumulativeMatrix||c:this.transformDirty&&(e=this.transform,g.copy(e,this.source.cumulativeMatrix||c),t=this.source.width/this.width,i=this.source.height/this.height,e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=i,e[5]*=i,e[6]*=i,e[7]*=i,this.uniforms.transform=e,this.transformDirty=!1),this.seriously.draw(this.seriously.baseShader,this.seriously.rectangleModel,this.uniforms,this.frameBuffer.frameBuffer,this,s),this.emit("render"),this.dirty=!1}},Q.prototype.renderSecondaryWebGL=function(){this.gl;var e=void 0,t=void 0,i=void 0,r=void 0,o=void 0;this.dirty&&this.ready&&this.source&&(this.emit("render"),this.source.render(!0),e=this.source.width,t=this.source.height,this.pixels&&this.pixels.length===e*t*4||(this.pixels=new Uint8Array(e*t*4)),this.source.readPixels(0,0,e,t,this.pixels),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.pixels),e===this.width&&t===this.height?this.uniforms.transform=c:this.transformDirty&&(i=this.transform,g.copy(i,c),r=this.source.width/this.width,o=this.source.height/this.height,i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r,i[4]*=o,i[5]*=o,i[6]*=o,i[7]*=o,this.uniforms.transform=i,this.transformDirty=!1),this.uniforms.source=this.texture,this.seriously.draw(this.shader,this.model,this.uniforms,null,this,s),this.dirty=!1)},Q.prototype.removeSource=function(e){this.source!==e&&this.source!==e.pub||(this.source=null)},Q.prototype.destroy=function(){this.source&&this.source.removeTarget&&this.source.removeTarget(this),this.seriously.removeTargetNode(this),this.plugin&&this.plugin.destroy&&this.plugin.destroy.call(this),delete this.source,delete this.target,delete this.pub,delete this.uniforms,delete this.pixels,delete this.auto,z.prototype.destroy.call(this)};var ee=window.document,te={canvas:[],image:[],video:[]},ie={},re={},oe={},se={},ne={},ae={},ue={},he=window.WeakMap&&new WeakMap,fe=function(){},de=0,le=void 0,ce=void 0;function pe(e){var t=void 0,i=void 0,r=void 0;for(r in e.inputs)if(e.inputs.hasOwnProperty(r)){if(e.reserved.indexOf(r)>=0||Object.prototype[r])throw new Error("Reserved input name: "+r);(t=e.inputs[r]).name=r,isNaN(t.min)&&(t.min=-1/0),isNaN(t.max)&&(t.max=1/0),isNaN(t.minCount)&&(t.minCount=-1/0),isNaN(t.maxCount)&&(t.maxCount=1/0),isNaN(t.step)&&(t.step=0),isNaN(t.mod)&&(t.mod=0),"enum"===t.type&&t.options&&m(t.options)&&t.options.length&&(i={},t.options.forEach(function(e,r){var o=void 0,s=void 0;m(e)?(o=e[0],s=e[1]||o):o=e,"string"==typeof o?o=o.toLowerCase():"number"==typeof o?o=String(o):o||(o=""),i[o]=s,r||(t.firstValue=o)}),t.options=i),"vector"===t.type?t.dimensions<2?t.dimensions=2:t.dimensions>4?t.dimensions=4:!t.dimensions||isNaN(t.dimensions)?t.dimensions=4:t.dimensions=Math.round(t.dimensions):t.dimensions=1,t.shaderDirty=!!t.shaderDirty,"function"!=typeof t.validate&&(t.validate=me.inputValidators[t.type]||function(e){return e}),e.defaultImageInput||"image"!==t.type||(e.defaultImageInput=r)}}function me(e){function t(){var e=this.gl,t=void 0,i=void 0,r=void 0,o=void 0;if(this.primaryTarget&&!e){if(i=this.primaryTarget.target,S(i,"WebGLFramebuffer"))return void T.error("Unable to restore target built on WebGLFramebuffer");if(t=O(i,{alpha:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!0,debugContext:this.primaryTarget.debugContext})){if(t.isContextLost())return void T.error("Unable to restore WebGL Context");for(this.attachContext(t),this.primaryTarget.renderToTexture?this.primaryTarget.frameBuffer=new G(e,this.primaryTarget.width,this.primaryTarget.height,!1):this.primaryTarget.frameBuffer={frameBuffer:null},r=0;r<a.length;r++)(o=a[r]).setDirty(),o.emit("webglcontextrestored");T.log("WebGL context restored")}}}function i(e){var t=this.gl,r=void 0,o=void 0;for(e&&(T.warn("WebGL context lost"),e.preventDefault()),R&&(N(R),R=0),b&&b.removeEventListener("webglcontextlost",i.bind(this),!1),r=0;r<m.length;r++)(o=m[r]).gl=null,o.initialized=!1,o.baseShader=null,o.model=null,o.frameBuffer=null,o.texture=null,o.shader&&o.shader.destroy&&(o.shader.destroy(),o.effect.commonShader&&delete this.commonShaders[o.hook]),o.shaderDirty=!0,o.shader=null,o.effect.lostContext&&o.effect.lostContext.call(o),e&&o.emit("webglcontextlost");for(r=0;r<h.length;r++)(o=h[r]).texture=null,o.initialized=!1,o.allowRefresh=!1,e&&o.emit("webglcontextlost");for(r=0;r<c.length;r++)(o=c[r]).frameBuffer=null,o.texture=null,e&&o.emit("webglcontextlost");for(r=0;r<f.length;r++)(o=f[r]).model=!1,o.frameBuffer=null,e&&o.emit("webglcontextlost");this.baseShader&&this.baseShader.destroy&&this.baseShader.destroy(),t&&(t.deleteBuffer(this.rectangleModel.vertex),t.deleteBuffer(this.rectangleModel.texCoord),t.deleteBuffer(this.rectangleModel.index)),this.rectangleModel&&(delete this.rectangleModel.vertex,delete this.rectangleModel.texCoord,delete this.rectangleModel.index),this.rectangleModel=null,this.baseShader=null,this.gl=t=null,b=null}function r(e){var t=void 0,i=void 0,o=!1;if(R=0,v.length)for(o=!0,t=0;t<v.length;t++)v[t].call(s,e);if(h&&h.length)for(o=!0,t=0;t<h.length;t++)((i=h[t]).dirty||i.checkDirty&&i.checkDirty())&&(i.dirty=!1,i.setDirty());for(t=0;t<f.length;t++)(i=f[t]).auto&&i.dirty&&i.render();if(y.length)for(o=!0,t=0;t<y.length;t++)y[t].call(s);o&&!R&&(R=A(r))}if(window===this||!(this instanceof me)||void 0!==this.id)return new me(e);var o=++de,s=this,n=0,a=[],u={},h=[],f=[],c=[],m=[],g={},v=[],y=[],E={},b=void 0,w=!1,R=void 0;this.commonShaders={},this.auto=!1,e=S(e,"HTMLCanvasElement")?{canvas:e}:e||{},this.attachContext=function(e){var r=this.gl,o=void 0,s=void 0;if(!r)if(e.canvas.addEventListener("webglcontextlost",i.bind(this),!1),e.canvas.addEventListener("webglcontextrestored",t.bind(this),!1),e.isContextLost())T.warn("Unable to attach lost WebGL context. Will try again when context is restored.");else{for(this.gl=r=e,b=e.canvas,this.rectangleModel=C(r),this.baseShader=new k(r,"#define SHADER_NAME seriously.base\n"+d,"#define SHADER_NAME seriously.base\n"+l),o=0;o<m.length;o++)(s=m[o]).gl=r,s.initialize(),s.buildShader();for(o=0;o<h.length;o++)(s=h[o]).initialize();for(o=0;o<f.length;o++)(s=f[o]).model||(s.model=this.rectangleModel,s.shader=this.baseShader)}},this.effect=function(e,t){if(!ie[e])throw new Error("Unknown effect: "+e);return new Y(this,e,ie[e],t).pub},this.source=function(e,t,i){return this.findInputNode(e,t,i).pub},this.transform=function(t,i){if("string"!=typeof t&&(i=t,t=!1),t){if(!re[t])throw new Error("Unknown transform: "+t)}else if(t=e&&e.defaultTransform||"2d",!re[t])throw new Error("No transform specified");return new Z(this,t,re[t],i).pub},this.target=function(e,t,i){var r=void 0,o=void 0,s=void 0;for(e&&"string"==typeof e&&!se[e]&&(o=ee.querySelector(e)),("string"!=typeof e||!t&&0!==t||o)&&(i&&"object"===(void 0===i?"undefined":x(i))||(i=t),t=o||e,e=null),"string"==typeof t&&isNaN(t)&&(t=ee.querySelector(t)),s=0;s<f.length;s++)if(r=f[s],(!e||e===r.hook)&&(r.target===t||r.compare&&r.compare(t,i)))return r.pub;return(r=new Q(this,e,t,i)).pub},this.aliases=function(){return Object.keys(g)},this.addAlias=function(e,t){g[e]=t},this.removeAlias=function(e){g[e]&&(delete this[e],delete g[e])},this.getNodeId=function(){return n++},this.findInputNode=function(e,t,i){var r=void 0,o=void 0;if(("string"!=typeof e||!t&&0!==t)&&(i&&"object"===(void 0===i?"undefined":x(i))||(i=t),t=e),"string"==typeof e&&oe[e]||(e=null),t instanceof W||t instanceof Y||t instanceof Z)r=t;else if(t instanceof H||t instanceof j||t instanceof K){if(!(r=u[t.id]))throw new Error("Cannot connect a foreign node")}else{for("string"==typeof t&&isNaN(t)&&(t=_(t,["canvas","img","video"])),o=0;o<h.length;o++)if(r=h[o],(!e||e===r.hook)&&r.compare&&r.compare(t,i))return r;r=new W(this,e,t,i)}return r},this.addNode=function(e){a.push(e),u[e.id]=e},this.removeNode=function(e){var t=a.indexOf(e);t>=0&&a.splice(t,1),delete u[e.id]},this.addSourceNode=function(e){this.addNode(e),h.push(e),te[e.hook].push(e),h.length&&!R&&r()},this.removeSourceNode=function(e){var t=h.indexOf(e);t>=0&&h.splice(t,1),(t=te[e.hook].indexOf(e))>=0&&te[e.hook].splice(t,1)},this.addEffectNode=function(e){this.addNode(e),m.push(e),ue[e.hook].push(e)},this.removeEffectNode=function(e){var t=void 0,i=void 0;for(t in g)g.hasOwnProperty(t)&&g[t].node===e&&this.removeAlias(t);(i=m.indexOf(e))>=0&&m.splice(i,1),(i=ue[e.hook].indexOf(e))>=0&&ue[e.hook].splice(i,1)},this.addTransformNode=function(e){this.addNode(e),c.push(e),ae[e.hook].push(e)},this.removeTransformNode=function(e){var t=void 0,i=void 0;for(t in g)g.hasOwnProperty(t)&&g[t].node===e&&s.removeAlias(t);(i=c.indexOf(e))>=0&&c.splice(i,1),(i=ae[e.hook].indexOf(e))>=0&&ae[e.hook].splice(i,1)},this.addTargetNode=function(e){var t=e.target,i=void 0;he&&((i=he.get(t))?me.logger.warn("Target already in use by another instance",t,Object.keys(i).map(function(e){return i[e]})):(i={},he.set(t,i)),i[this.id]=this),a.push(e),u[e.id]=e,f.push(e)},this.removeTargetNode=function(e){var r=void 0,o=void 0;he&&(delete(r=he.get(e.target))[s.id],Object.keys(r).length||he.delete(e.target)),(o=f.indexOf(e))>=0&&f.splice(o,1),e===this.primaryTarget&&(b.removeEventListener("webglcontextrestored",t.call(this),!1),i.call(this),this.primaryTarget=null)},this.defaults=function(e,t){var i=void 0;if(e)if("object"!==(void 0===e?"undefined":x(e))){if(null===t)delete E[e];else if("object"===(void 0===t?"undefined":x(t)))E[e]=p({},t);else if(void 0===t)return E[e]}else for(i in e)e.hasOwnProperty(i)&&this.defaults(i,e[i]);else if(null===e)for(i in E)E.hasOwnProperty(i)&&delete E[i]},this.draw=function(e,t,i,r,o,s){var n=0,a=void 0,u=void 0,h=void 0,f=void 0,d=void 0,l=this.gl,c=o&&o.gl||l,p=void 0,m=void 0,g=void 0,v=void 0;if(c){o?(f=s&&s.width||o.width||c.canvas.width,d=s&&s.height||o.height||c.canvas.height):(f=s&&s.width||c.canvas.width,d=s&&s.height||c.canvas.height),e.use(),c.viewport(0,0,f,d),c.bindFramebuffer(c.FRAMEBUFFER,r),c.enableVertexAttribArray(e.location.position),c.enableVertexAttribArray(e.location.texCoord),t.texCoord&&(c.bindBuffer(c.ARRAY_BUFFER,t.texCoord),c.vertexAttribPointer(e.location.texCoord,t.texCoord.size,c.FLOAT,!1,0,0)),c.bindBuffer(c.ARRAY_BUFFER,t.vertex),c.vertexAttribPointer(e.location.position,t.vertex.size,c.FLOAT,!1,0,0),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.index),s&&s.depth?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),s?void 0===s.blend||s.blend?(l.enable(l.BLEND),p=void 0===s.srcRGB?l.ONE:s.srcRGB,g=s.dstRGB||l.ZERO,m=void 0===s.srcAlpha?p:s.srcAlpha,v=void 0===s.dstAlpha?g:s.dstAlpha,l.blendFuncSeparate(p,g,m,v),l.blendEquation(s.blendEquation||l.FUNC_ADD)):l.disable(l.BLEND):(l.enable(l.BLEND),l.blendFunc(l.ONE,l.ZERO),l.blendEquation(l.FUNC_ADD));for(a in i)i.hasOwnProperty(a)&&(u=i[a],(h=e.uniforms[a])&&(S(u,"WebGLTexture")?(c.activeTexture(c.TEXTURE0+n),c.bindTexture(c.TEXTURE_2D,u),h.set(n),n++):u instanceof W||u instanceof Y||u instanceof Z?u.texture&&(c.activeTexture(c.TEXTURE0+n),c.bindTexture(c.TEXTURE_2D,u.texture),h.set(n),n++):void 0!==u&&null!==u&&h.set(u)));s&&void 0!==s.clear&&!s.clear||(c.clearColor(0,0,0,0),c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT)),c.drawElements(t.mode,t.length,c.UNSIGNED_SHORT,0),l.enable(l.DEPTH_TEST)}},this.initDaemon=function(){R||(R=A(r))},this.go=function(e,t){var i=void 0;for("function"==typeof e&&v.indexOf(e)<0&&v.push(e),"function"==typeof t&&y.indexOf(t)<0&&y.push(t),this.auto=!0,i=0;i<f.length;i++)f[i].go();R||!v.length&&!y.length||r()},this.stop=function(){v.length=0,y.length=0,N(R),R=0},this.render=function(){var t=void 0;for(t=0;t<f.length;t++)f[t].render(e)},this.destroy=function(){for(var e=void 0,t=void 0;a.length;)a[0].pub.destroy();for(e in this)this.hasOwnProperty(e)&&"isDestroyed"!==e&&"id"!==e&&((t=Object.getOwnPropertyDescriptor(this,e)).get||t.set||"function"!=typeof this[e]?delete this[e]:this[e]=fe);s=null,h=[],f=[],m=[],a=[],v.length=0,y.length=0,N(R),R=0,w=!0},this.isDestroyed=function(){return w},this.incompatible=function(e){var t,i,r=me.incompatible(e);if(r)return r;if(!e){for(t in ue)if(ue.hasOwnProperty(t)&&ue[t].length&&(i=ie[t])&&"function"==typeof i.compatible&&!i.compatible.call(this))return"plugin-"+t;for(t in te)if(te.hasOwnProperty(t)&&te[t].length&&(i=oe[t])&&"function"==typeof i.compatible&&!i.compatible.call(this))return"source-"+t}return!1},this.isNode=function(e){var t=void 0;return!(!e||!(t=u[e.id])||t.isDestroyed)},this.isSource=function(e){return this.isNode(e)&&e instanceof j},this.isEffect=function(e){return this.isNode(e)&&e instanceof H},this.isTransform=function(e){return this.isNode(e)&&e instanceof K},this.isTarget=function(e){return this.isNode(e)&&e instanceof J},Object.defineProperties(this,{id:{enumerable:!0,configurable:!0,get:function(){return o}}}),this.defaults(e.defaults)}return me.traceSources=function e(t,i){var r=void 0,o=void 0,s=void 0;if(!(t instanceof Y||t instanceof Z))return!1;if(t===i)return!0;s=t.sources;for(r in s)if(s.hasOwnProperty(r)&&((o=s[r])===i||e(o,i)))return!0;return!1},me.incompatible=function(e){var t=void 0,i=void 0,r=void 0;if(void 0===ce&&((t=ee.createElement("canvas"))&&t.getContext?window.WebGLRenderingContext?(i=U(ce))||(ce="context"):ce="webgl":ce="canvas"),ce)return ce;if(e){if((r=ie[e])&&"function"==typeof r.compatible&&!r.compatible(i))return"plugin-"+e;if((r=oe[e])&&"function"==typeof r.compatible&&!r.compatible(i))return"source-"+e}return!1},me.plugin=function(e,t,i){var r=void 0;if(ie[e])me.logger.warn("Effect ["+e+"] already loaded");else if(void 0===i&&"object"===(void 0===t?"undefined":x(t))&&(i=t),i)return r=p({},i),"function"==typeof t&&(r.definition=t),r.reserved=u,r.inputs&&pe(r),r.title||(r.title=e),ie[e]=r,ue[e]=[],r},me.removePlugin=function(e){var t=void 0;if(!e)return this;if(!ie[e])return this;if(t=ue[e]){for(;t.length;)t.shift().destroy();delete ue[e]}return delete ie[e],this},me.source=function(e,t,i){var r=void 0;if(oe[e])me.logger.warn("Source ["+e+"] already loaded");else if(void 0===i&&"object"===(void 0===t?"undefined":x(t))&&(i=t),i||t)return r=p({},i),"function"==typeof t&&(r.definition=t),r.title||(r.title=e),oe[e]=r,te[e]=[],r},me.removeSource=function(e){var t=void 0;if(!e)return this;if(!oe[e])return this;if(t=te[e]){for(;t.length;)t.shift().destroy();delete te[e]}return delete oe[e],this},me.transform=function(e,t,i){var r=void 0;if(re[e])me.logger.warn("Transform ["+e+"] already loaded");else if(void 0===i&&"object"===(void 0===t?"undefined":x(t))&&(i=t),i||t)return r=p({},i),"function"==typeof t&&(r.definition=t),r.reserved=h,r.inputs&&pe(r),r.title||(r.title=e),re[e]=r,ae[e]=[],r},me.removeTransform=function(e){var t=void 0;if(!e)return this;if(!re[e])return this;if(t=ae[e]){for(;t.length;)t.shift().destroy();delete ae[e]}return delete re[e],this},me.target=function(e,t,i){var r=void 0;if(se[e])me.logger.warn("Target ["+e+"] already loaded");else if(void 0===i&&"object"===(void 0===t?"undefined":x(t))&&(i=t),i||t)return r=p({},i),"function"==typeof t&&(r.definition=t),r.title||(r.title=e),se[e]=r,ne[e]=[],r},me.removeTarget=function(e){var t=void 0;if(!e)return this;if(!se[e])return this;if(t=ne[e]){for(;t.length;)t.shift().destroy();delete ne[e]}return delete se[e],this},me.sourcePlugin=function(e,t,i,r,o){var s=oe[t];if(s&&s.definition){if(!(s=s.definition.call(e,i,r,o)))return null;s=p(p({},oe[t]),s)}return s},me.getTarget=function(e){return se[e]},me.forEachSource=function(e){for(var t in oe)if(oe.hasOwnProperty(t)&&oe[t]&&!1===e(t,oe[t]))break},me.forEachTarget=function(e){for(var t in se)if(se.hasOwnProperty(t)&&se[t]&&!1===e(t,oe[t]))break},me.inputValidators={color:function(r,s,n,a){var u,h,f,d;if(h=a||[],"string"==typeof r){if((f=t.exec(r))&&f.length){if(f.length<3)return h[0]=h[1]=h[2]=h[3]=0,h;for(h[3]=1,d=0;d<3;d++)h[d]=parseFloat(f[d+2])/255;return isNaN(f[6])||(h[3]=parseFloat(f[6])),"hsl"===f[1].toLowerCase()?v(h[0],h[1],h[2],h[3],h):h}if((f=i.exec(r))&&f.length)return 3===(u=f[1]).length?(h[0]=parseInt(u[0],16)/15,h[1]=parseInt(u[1],16)/15,h[2]=parseInt(u[2],16)/15,h[3]=1):4===u.length?(h[0]=parseInt(u[0],16)/15,h[1]=parseInt(u[1],16)/15,h[2]=parseInt(u[2],16)/15,h[3]=parseInt(u[3],16)/15):6===u.length?(h[0]=parseInt(u.substr(0,2),16)/255,h[1]=parseInt(u.substr(2,2),16)/255,h[2]=parseInt(u.substr(4,2),16)/255,h[3]=1):8===u.length?(h[0]=parseInt(u.substr(0,2),16)/255,h[1]=parseInt(u.substr(2,2),16)/255,h[2]=parseInt(u.substr(4,2),16)/255,h[3]=parseInt(u.substr(6,2),16)/255):h[0]=h[1]=h[2]=h[3]=0,h;if(f=e[r.toLowerCase()]){for(d=0;d<4;d++)h[d]=f[d];return h}return le||(le=ee.createElement("canvas").getContext("2d")),le.fillStyle=r,(u=le.fillStyle)&&"#000000"!==u?me.inputValidators.color(u,s,n,a):(h[0]=h[1]=h[2]=h[3]=0,h)}if(m(r)){if((h=r).length<3)return h[0]=h[1]=h[2]=h[3]=0,h;for(d=0;d<3;d++)if(isNaN(h[d]))return h[0]=h[1]=h[2]=h[3]=0,h;return h.length<4&&h.push(1),h}if("number"==typeof r)return h[0]=h[1]=h[2]=r,h[3]=1,h;if("object"===(void 0===r?"undefined":x(r))){for(d=0;d<4;d++)null===r[u=o[d]]||isNaN(r[u])?h[d]=3===d?1:0:h[d]=r[u];return h}return h[0]=h[1]=h[2]=h[3]=0,h},number:function(e,t,i){return e=parseFloat(e),isNaN(e)?i||0:(t.mod&&(e-=t.mod*Math.floor(e/t.mod)),e<t.min?t.min:e>t.max?t.max:t.step?Math.round(e/t.step)*t.step:e)},enum:function(e,t,i){var r=t.options||[];return"string"==typeof e?e=e.toLowerCase():"number"==typeof e?e=e.toString():e||(e=""),r.hasOwnProperty(e)?e:i||""},vector:function(e,t,i,s){var n=void 0,a=void 0,u=void 0,h=t.dimensions||4;if(n=s||[],m(e)){for(a=0;a<h;a++)n[a]=e[a]||0;return n}if("object"===(void 0===e?"undefined":x(e))){for(a=0;a<h;a++)void 0===e[u=r[a]]&&(u=o[a]),n[a]=e[u]||0;return n}for(e=parseFloat(e)||0,a=0;a<h;a++)n[a]=e;return n},boolean:function(e){return!!e&&(!e||!e.toLowerCase||"false"!==e.toLowerCase())},string:function(e){return"string"==typeof e?e:0===e||e?e.toString?e.toString():String(e):""}},me.validateInputSpecs=pe,me.prototype.effects=me.effects=function(){var e=void 0,t=void 0,i=void 0,r={},o=void 0,s=void 0;for(e in ie)if(ie.hasOwnProperty(e)){i={title:(t=ie[e]).title||e,description:t.description||"",inputs:{}};for(s in t.inputs)t.inputs.hasOwnProperty(s)&&(o=t.inputs[s],i.inputs[s]={type:o.type,defaultValue:o.defaultValue,step:o.step,min:o.min,max:o.max,mod:o.mod,minCount:o.minCount,maxCount:o.maxCount,dimensions:o.dimensions,title:o.title||s,description:o.description||"",options:o.options||[]});r[e]=i}return r},me.prototype.getTarget=function(e){return se[e]},me.prototype.hasTarget=function(e){return!!se[e]},window.Seriously&&"object"===x(window.Seriously)&&function(){var e=void 0;for(e in window.Seriously)window.Seriously.hasOwnProperty(e)&&"plugin"!==e&&"object"===x(window.Seriously[e])&&me.plugin(e,window.Seriously[e])}(),me.logger=T,me.util={mat4:g,checkSource:function(e){return L(e,ce)},hslToRgb:v,colors:e,setTimeoutZero:F,ShaderProgram:k,FrameBuffer:G,requestAnimationFrame:A},me.plugin("sepia",{commonShader:!0,shader:function(e,t){return t.fragment=["precision mediump float;","varying vec2 vTexCoord;","uniform sampler2D source;","uniform vec4 light;","uniform vec4 dark;","uniform float desat;","uniform float toned;","const mat4 coeff = mat4(0.393, 0.349, 0.272, 1.0,0.796, 0.686, 0.534, 1.0, 0.189, 0.168, 0.131, 1.0, 0.0, 0.0, 0.0, 1.0 );","void main(void) {","\tvec4 sourcePixel = texture2D(source, vTexCoord);","\tgl_FragColor = coeff * sourcePixel;","}"].join("\n"),t},inPlace:!0,inputs:{source:{type:"image",uniform:"source"}},title:"Sepia",description:""}),me.plugin("brightness-contrast",{commonShader:!0,shader:function(e,t){return t.fragment=["precision mediump float;","varying vec2 vTexCoord;","uniform sampler2D source;","uniform float brightness;","uniform float saturation;","uniform float contrast;","const vec3 half3 = vec3(0.5);","void main(void) {","\tvec4 pixel = texture2D(source, vTexCoord);","\tvec3 color = pixel.rgb * brightness;","\tcolor = (color - half3) * contrast + half3;","\tgl_FragColor = vec4(color, pixel.a);","}"].join("\n"),t},inPlace:!0,inputs:{source:{type:"image",uniform:"source"},brightness:{type:"number",uniform:"brightness",defaultValue:1,min:0},contrast:{type:"number",uniform:"contrast",defaultValue:1,min:0}},title:"Brightness/Contrast",description:"Multiply brightness and contrast values. Works the same as CSS filters."}),me.plugin("hue-saturation",{commonShader:!0,shader:function(e,t){return t.vertex=["precision mediump float;","attribute vec4 position;","attribute vec2 texCoord;","uniform vec2 resolution;","uniform mat4 projection;","uniform mat4 transform;","uniform float hue;","uniform float saturation;","varying vec2 vTexCoord;","varying vec3 weights;","void main(void) {","\tfloat angle = hue * 3.14159265358979323846264;","\tfloat s = sin(angle);","\tfloat c = cos(angle);","\tweights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;","\tvec4 screenPosition = vec4(position.xy * resolution / 2.0, position.z, position.w);","\tscreenPosition = transform * screenPosition;","\tgl_Position = screenPosition;","\tgl_Position.xy = screenPosition.xy * 2.0 / resolution;","\tgl_Position.z = screenPosition.z * 2.0 / (resolution.x / resolution.y);","\tvTexCoord = texCoord;","}"].join("\n"),t.fragment=["precision mediump float;","varying vec2 vTexCoord;","varying vec3 weights;","uniform sampler2D source;","uniform float hue;","uniform float saturation;","void main(void) {","\tvec4 color = texture2D(source, vTexCoord);","\tfloat len = length(color.rgb);","\tcolor.rgb = vec3(dot(color.rgb, weights.xyz), dot(color.rgb, weights.zxy), dot(color.rgb, weights.yzx) );","\tvec3 adjustment = (color.r + color.g + color.b) / 3.0 - color.rgb;","\tif (saturation > 0.0) {","\t\tadjustment *= (1.0 - 1.0 / (1.0 - saturation));","\t} else {","\t\tadjustment *= (-saturation);","\t}","\tcolor.rgb += adjustment;","\tgl_FragColor = color;","}"].join("\n"),t},inPlace:!0,inputs:{source:{type:"image",uniform:"source"},hue:{type:"number",uniform:"hue",defaultValue:.4,min:-1,max:1},saturation:{type:"number",uniform:"saturation",defaultValue:0,min:-1,max:1}},title:"Hue/Saturation",description:"Rotate hue and multiply saturation."}),me}});
